{{template "base" .}}

{{define "title"}}Search // LORE{{end}}

{{define "content"}}
<!-- TAGS CLOUD -->
<div class="section">
    <div class="section-header">
        <span class="section-title">Tags</span>
        <span class="section-badge">Filter</span>
        <span class="section-count">{{len .AllTags}} tags</span>
    </div>
    <div class="tags-filter-section">
        <div class="tags-cloud">
            {{range .AllTags}}
            {{$isSelected := containsTag $.Tags .TagName}}
            <a href="{{tagURL $.Tags .TagName (not $isSelected) $.Query}}" class="tag-chip{{if $isSelected}} selected{{end}}">
                [{{.TagName}}]<span class="tag-count">{{.Count}}</span>
            </a>
            {{end}}
            {{if not .AllTags}}
            <div class="tags-empty">No tags found</div>
            {{end}}
        </div>
    </div>
</div>

<!-- SEARCH TERMINAL -->
<div class="search-section">
    <div class="search-terminal-label">QUERY TERMINAL</div>
    <form action="/search" method="get" class="search-form">
        {{range .Tags}}
        <input type="hidden" name="tag" value="{{.}}">
        {{end}}
        <div class="search-input-wrapper">
            <span class="search-prompt">&gt;</span>
            <input type="text" name="q" class="search-input" value="{{.Query}}"
                   placeholder="SEARCH BY NAME OR ACCOUNT ID..." autocomplete="off" autofocus>
            <button type="submit" class="search-btn">[SEARCH]</button>
        </div>
    </form>
</div>

{{if .Tags}}
<div class="tags-active-section">
    <div class="tags-active-header">Active Filters (AND)</div>
    <div class="tags-active-list">
        {{range .Tags}}
        <a href="{{tagURL $.Tags . false $.Query}}" class="tag-active">
            [{{.}}]<span class="tag-remove">x</span>
        </a>
        {{end}}
        {{if gt (len .Tags) 1}}
        <a href="/search{{if .Query}}?q={{.Query}}{{end}}" class="tag-clear">[CLEAR ALL]</a>
        {{end}}
    </div>
</div>
{{end}}

{{if .QueryTooLong}}
<!-- Query too long -->
<div class="search-prompt-section">
    <div class="search-prompt-text">Query too long (maximum 100 characters)</div>
</div>
{{else if or .Query .Tags}}
{{if or (ge (len .Query) 2) .Tags}}
<!-- SEARCH RESULTS HEADER -->
<div class="search-results-header">
    <div class="search-query-display">
        {{if .Query}}
        <span class="search-query-label">Query:</span>
        <span class="search-query-value">"{{.Query}}"</span>
        {{end}}
        {{if and .Query .Tags}}
        <span class="search-query-label">+</span>
        {{end}}
        {{if .Tags}}
        <span class="search-query-label">Tags:</span>
        <span class="search-query-value">{{range $i, $t := .Tags}}{{if $i}}, {{end}}{{$t}}{{end}}</span>
        {{end}}
    </div>
    <div class="search-results-meta">
        <div class="search-results-count">{{.TotalCount}} results found</div>
        <div class="search-sort-toggle">
            <span class="sort-label">Sort:</span>
            <a href="/search?{{if .Query}}q={{urlquery .Query}}&{{end}}{{range .Tags}}tag={{urlquery .}}&{{end}}sort=balance" class="sort-option{{if eq .SortBy "balance"}} active{{end}}">[Balance]</a>
            <a href="/search?{{if .Query}}q={{urlquery .Query}}&{{end}}{{range .Tags}}tag={{urlquery .}}&{{end}}sort=reputation" class="sort-option{{if eq .SortBy "reputation"}} active{{end}}">[Reputation]</a>
        </div>
    </div>
</div>

{{if .Accounts}}
<div class="section">
    <div class="section-header">
        <span class="section-title">Results</span>
        <span class="section-count">{{.TotalCount}} accounts</span>
    </div>
    <div class="table-wrapper">
        <table class="data-table">
            <thead>
                <tr>
                    <th>#</th>
                    <th>Name</th>
                    <th>Type</th>
                    <th class="right">Balance</th>
                    <th class="right">Portfolio</th>
                    <th class="right">Rep</th>
                </tr>
            </thead>
            <tbody>
                {{$offset := .Offset}}
                {{range $idx, $acc := .Accounts}}
                <tr class="row-link" onclick="window.location='/accounts/{{$acc.AccountID}}'">
                    <td class="cell-rank">{{add $offset (add $idx 1)}}</td>
                    <td class="cell-name">
                        <a href="/accounts/{{$acc.AccountID}}">{{$acc.Name}}</a>
                        <div class="cell-id">{{truncateID $acc.AccountID}}</div>
                    </td>
                    <td>
                        {{if $acc.IsPerson}}<span class="type-badge type-person">[MTLAP]</span>{{end}}
                        {{if $acc.IsCorporate}}<span class="type-badge type-corporate">[MTLAC]</span>{{end}}
                    </td>
                    <td class="cell-num">
                        {{if $acc.IsPerson}}{{formatNumber $acc.MTLAPBalance}}{{end}}
                        {{if and $acc.IsPerson $acc.IsCorporate}} / {{end}}
                        {{if $acc.IsCorporate}}{{formatNumber $acc.MTLACBalance}}{{end}}
                    </td>
                    <td class="cell-xlm">{{if gt $acc.TotalXLMValue 0.0}}{{formatNumber $acc.TotalXLMValue}} XLM{{else}}-{{end}}</td>
                    <td class="cell-rep">{{if $acc.ReputationGrade}}<span class="rep-grade">{{$acc.ReputationGrade}}</span> <span class="rep-weight">({{printf "%.1f" $acc.ReputationWeight}})</span>{{else}}-{{end}}</td>
                </tr>
                {{end}}
            </tbody>
        </table>
    </div>

    {{if .HasMore}}
    <div class="pagination">
        <a href="/search?{{if .Query}}q={{urlquery .Query}}&{{end}}{{range .Tags}}tag={{urlquery .}}&{{end}}sort={{.SortBy}}&offset={{.NextOffset}}" class="btn">Load More</a>
    </div>
    {{end}}
</div>
{{else}}
<div class="search-no-results">
    <div class="search-no-results-text">No accounts found matching your search criteria</div>
</div>
{{end}}

{{else if .Query}}
<!-- Query too short -->
<div class="search-prompt-section">
    <div class="search-prompt-text">Enter at least 2 characters to search</div>
</div>
{{end}}

{{else}}
<!-- No query entered -->
<div class="search-prompt-section">
    <div class="search-prompt-text">Enter a name or account ID to search, or select tags to filter</div>
</div>
{{end}}
{{end}}
